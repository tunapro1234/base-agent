# LLM Client Implementation Spec (Single-Package Providers)

_meta:
  version: "0.4.0"
  type: spec

implementation:
  structure:
    - __init__.py
    - types.py
    - router.py
    - rotation.py
    - gemini_adapter.py
    - codex_adapter.py
    - opus_adapter.py

  router:
    pseudocode: |
      class LLMRouter:
        def __init__(self, default_provider: str = "gemini"):
          self.default_provider = default_provider
          self._providers: dict[str, ProviderAdapter] = {}

        def register_provider(self, name: str, adapter: ProviderAdapter):
          self._providers[name] = adapter

        def complete(self, request: CompletionRequest) -> LLMResponse:
          provider = request.provider or self.default_provider
          if provider not in self._providers:
            raise ValueError(f"Provider not registered: {provider}")
          return self._providers[provider].complete(request)

  types:
    pseudocode: |
      @dataclass
      class CompletionRequest:
        messages: list[Message]
        tools: list[ToolSchema] | None = None
        temperature: float | None = None
        model: str | None = None
        provider: str | None = None
        metadata: dict | None = None

      @dataclass
      class LLMResponse:
        content: str
        tool_calls: list[ToolCall] | None = None
        raw: dict | None = None

      class ProviderError(Exception):
        code: str
        message: str
        retryable: bool

  rotation_contract:
    notes: |
      Provider adapter'lar kendi rate-limit hatalarini
      RotationManager'a bildirir.
      RotationManager slot secimi + cooldown + backoff uygular.

  providers:
    notes: |
      Provider adapter'lar:
      - request/response mapping'i yapar
      - model allowlist uygular
      - rotation manager ile key/account donusumunu yapar
      - tek paket altinda tutulur (subpackage yok)

tests:
  unit:
    - name: router_requires_provider
      test: |
        router = LLMRouter()
        try:
          router.complete(CompletionRequest(messages=[]))
          assert False
        except ValueError:
          pass
